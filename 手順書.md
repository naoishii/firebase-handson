
# Firebaseハンズオン

## 準備
まずはReactの準備

create-react-appで雛形を作る

その他もろもろも準備。最新の環境でやっていこうぜ。  
とはいえ設定ファイルもすべてgitに上がっているのでそれを使えばOKです。

* eslint
* prettier
  + vscodeにprettierプラグインを設定してくれよな

https://github.com/naoishii/firebase-handson/blob/master/.eslintrc.js

## 準備2 Reactによるチャットアプリの作成
今回はFirebaseの話なのでここはコピーで済ませちゃいましょう。
step2ブランチをコピーしたらOKです

## firebseの準備とついでにhosting
Webでの登録とかは雰囲気でやっちゃってほしい。

ログイン→プロジェクトの作成

詳しくはReact入門（翔泳社）12章参照


### hosting
勢いにのってホスティングまでやる。
プロジェクト→hosting→使ってみる  
言われるがままにcliもインストールする。  
コマンドラインで対話型のインターフェイスによってどの機能を使うか（どの機能のコンフィグファイルを自動生成するか）を聞かれる。  
必要なものにspaceでチェックを付けてenter
1点、hostingに関して公開するのはどのディレクトリかを聞かれる。デフォルトはpublicだが、create-react-appはbuildなのでbuildにすると便利だと思う。

以下のコマンドでデプロイできる
```
firebase deploy
```
無事成功したらURLが表示されるのでアクセスして確認してみよう。

もしもりもりでFirebaseの設定をした場合、deployが遅くなることがある。  
変更に関連するサービスのみdeployしたい場合は
```
firebase deploy --only hosting
```
のように対象を絞ることができる

## Firebse Authentication(認証)
https://firebase.google.com/docs/auth/?authuser=0

https://github.com/pirosikick/react-hands-on-20171023/tree/master/5-use-firebase


## 認証機能を使う
デフォルトでは認証機能はOFFなのでwebUIから有効化する。

DEVELOP→ログイン方法(を設定)

匿名とgoogleを有効化しましょう。余裕があればTwitter, Github, Facebookもやりたい。

とりあえずUI上での設定は終了。コードに移っていきます。

### 認証を行うコードを書く
hostingはJSには修正はありませんでしたが、認証からはコードを書いていきます。
firebaseの機能を使うためのパッケージがあるのでインストールします。
```
npm install --save firebase
```
`step4-hanuke`ブランチを元にやっていきましょう。

### アプリケーションの初期化
https://firebase.google.com/docs/web/setup?authuser=0
API key などを取得します。
Project OverViewから「ウェブアプリに Firebase を追加」をクリックし、設定を取得します。公開しても大丈夫なようです。

この辺からはReact/Reduxと違ってnaoishiiの経験が浅くてベストプラクティスかどうかはわかりませんよと予めお断りさせてくださいｗ

firebaseの設定をするだけのファイルを作ります。`src/firebase.js`というファイルを作成し、先ほどコピーした設定を適用します。
```js
import firebase from 'firebase';

const firebaseApp = firebase.initializeApp({
  こぴーぺ
});

export default firebaseApp;
```

firebaseとのやり取りはイベントベースで行われます。firebaseのイベントをフックにreduxのアクションを発火したいので、storeを受け取りイベントを登録するコードを書きます。
中身はまだなくて良いです。
```js
const connectFirebase = store => {
  // store.dipatch()でアクションが発火
};

export { connectFirebase };
```

app.jsで今作った関数にstoreを渡します
```js
...
import createStore from './createStore';
import { connectFirebase } from './firebase';

const store = createStore();
connectFirebase(store);
...
```

一旦準備OK

### 匿名認証
まずは手始めに匿名認証を行います。匿名認証を行うことでパスワードなどを使わずに個人を特定し、データベースなどにアクセスすることができます。
もちろん、ブラウザが変わったりした場合は情報を引き継ぐことはできません。
https://firebase.google.com/docs/auth/web/anonymous-auth?authuser=0

ユーザが匿名認証する、というボタンを押したときに認証を行いたいので、対応するactionに認証を行うコードを書きます。
modules/user.js
```js
import firebaseApp from '../firebase';

...

const anonymousLogin = () => {
  return dispatch => {
    firebaseApp
      .auth()
      .signInAnonymously()
      .catch(function(error) {
        // Handle Errors here.
        const errorCode = error.code;
        const errorMessage = error.message;

        console.log(errorCode, errorMessage);
        dispatch(error());
      });
  };
};
```

認証はこの場では完了せず、非同期的に認証されイベントを発火する形で完了します。  
イベントを受けるコードを書きましょう。
先程作成したconnectFirebaseでイベントリスナーを書きます。
```js
const connectFirebase = store => {
  firebase.auth().onAuthStateChanged(user => {
    console.log(user);
    if (user) {
      // User is signed in.
      const isAnonymous = user.isAnonymous;
      const uid = user.uid;

      store.dispatch(userAction.login(uid));
      store.dispatch(userAction.updateUsername(user.displayName || uid));
    } else {
      // User is signed out.
      const uid = user.uid;
      store.dispatch(userAction.logout(uid));
    }
  });
}
```

以上で匿名認証ができました。

### google認証
googleIDと紐付けて認証を行います。
firebaseはgoogleのサービスなので（かどうかは知りませんが）めちゃお手軽に認証を行うことができます。
https://firebase.google.com/docs/auth/web/google-signin?authuser=0


これも「google認証」をクリックすることで認証したいのでactionとして記述します。まあこの例ではコンポーネントに直接書いてもいいんですが、あちこちだとわかりづらいのでactionとして書きます。
```js
const googleLogin = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithRedirect(provider);

  // 今回は特に何もしない
  return {
    type: 'GOOGLE_LOGIN',
  };
};
```
今回はいくつかある認証方法のうち、リダイレクトを利用する認証にしました。  
当然ですが、リダイレクトしただけでは認証されませんので何かをreturnする必要はありません。

公式ドキュメントには`firebase.auth().getRedirectResult()`を用いてリダイレクトから帰ってきたときの処理を行っていますが、今回は匿名認証のときに使った`firebase.auth().onAuthStateChanged()`が処理を行っているので記述する必要はありません。認証状態が変化しているので onAuthStateChanged が発火するのもうなずけますね。



























